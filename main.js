(()=>{"use strict";const e={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};class t{constructor(e,t="generic"){if(this.level=e,this.attack=0,this.defence=0,this.health=100,this.type=t,"Character"===new.target.name)throw new Error("Нельзя использовать new Character()")}}class a{constructor(e,a){if(!(e instanceof t))throw new Error("character must be instance of Character or its children");if("number"!=typeof a)throw new Error("position must be a number");this.character=e,this.position=a}}class s extends t{constructor(e){super(e),this.attack=25,this.defence=25,this.type="bowman"}}class r extends t{constructor(e){super(e),this.attack=10,this.defence=10,this.type="daemon"}}class i extends t{constructor(e){super(e),this.attack=40,this.defence=10,this.type="swordsman"}}class c extends t{constructor(e){super(e),this.attack=10,this.defence=40,this.type="magician"}}class l extends t{constructor(e){super(e),this.attack=40,this.defence=10,this.type="undead"}}class o extends t{constructor(e){super(e),this.attack=25,this.defence=25,this.type="vampire"}}class h{constructor(e){this.characters=e}}function n(e,t,a){const s=[],r=function*(e,t){let a,s;for(;;)a=Math.floor(Math.random()*e.length),s=Math.floor(Math.random()*t+1),yield new e[a](s)}(e,t);for(let e=0;e<a;e++)s.push(r.next().value);return new h(s)}const d=new class{constructor(){this.gameLevel=1,this.playerTeam=[],this.compTeam=[],this.selectedChar={},this.turn="player",this.playerScore=0,this.compScore=0,this.hiScore=0}},m=new class{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="messageBox"></div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n        <div class="boardCover"></div>\n      </div>\n      <div class="stats">\n        <div class="scores">\n          <div>Очки игрока</div>\n          <div class="playerScore"></div>\n        </div>\n        <div class="scores">\n          <div>Очки компьютера</div>\n          <div class="compScore"></div>\n        </div>\n        <div class="scores">\n          <div>Рекорд</div>\n          <div class="hiScore"></div>\n        </div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const s=document.createElement("div");s.classList.add("cell","map-tile",`map-tile-${t=e,a=this.boardSize,function(e,t){if(e<t)return 0===e?"top-left":e===t-1?"top-right":"top"}(t,a)||function(e,t){if(e>=t**2-t)return e===t**2-t?"bottom-left":e===t**2-1?"bottom-right":"bottom"}(t,a)||function(e,t){if(e%t==0)return"left"}(t,a)||function(e,t){if((e+1)%t==0)return"right"}(t,a)||"center"}`),s.addEventListener("mouseenter",(e=>this.onCellEnter(e))),s.addEventListener("mouseleave",(e=>this.onCellLeave(e))),s.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(s)}var t,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const r=document.createElement("div");r.classList.add("health-level");const i=document.createElement("div");i.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),i.style.width=`${a.character.health}%`,r.appendChild(i),s.appendChild(r),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],r=document.createElement("span");r.textContent=t,r.classList.add("damage"),s.appendChild(r),r.addEventListener("animationend",(()=>{s.removeChild(r),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}};m.bindToDOM(document.querySelector("#game-container"));const p=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),u=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.places,this.messageTimeout=0}init(){this.gamePlay.drawUi(e[this.theamSelect()]);const t=this.createTeams();this.places=this.placeCharacters(t),this.gamePlay.redrawPositions(this.places),this.restoreHiScore(),this.updateScores(),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener((()=>this.startNewGame())),this.gamePlay.addLoadGameListener((()=>this.loadGame())),this.gamePlay.addSaveGameListener((()=>this.saveGame()))}onCellClick(e){const t=d.playerTeam.find((t=>t.position===e)),a=d.compTeam.find((t=>t.position===e));0===Object.keys(d.selectedChar).length?t?(this.gamePlay.selectCell(e),d.selectedChar.character=t.character,d.selectedChar.position=t.position):this.showMessage("Надо выбрать своего персонажа","white"):this.playerTurn(e,t,a)}onCellEnter(e){const t=d.playerTeam.find((t=>t.position===e)),a=d.compTeam.find((t=>t.position===e));if((t||a)&&this.gamePlay.showCellTooltip(this.getCharInfo(e),e),0===Object.keys(d.selectedChar).length)t?this.gamePlay.setCursor("pointer"):this.gamePlay.setCursor("not-allowed");else{const s=this.findAllowedToTurn(d.selectedChar.position,d.selectedChar.character.type),r=this.findAllowedToAttack(d.selectedChar.position,d.selectedChar.character.type);t?this.gamePlay.setCursor("pointer"):a?r.includes(e)?this.gamePlay.setCursor("crosshair"):this.gamePlay.setCursor("not-allowed"):s.includes(e)?(this.gamePlay.setCursor("pointer"),this.gamePlay.selectCell(e,"green")):this.gamePlay.setCursor("not-allowed")}}onCellLeave(e){const t=d.playerTeam.find((t=>t.position===e));this.gamePlay.hideCellTooltip(e),t||this.gamePlay.deselectCell(e)}createTeams(){const e=[l,o,r],t=n([s,i,c],d.gameLevel,d.gameLevel+1-d.playerTeam.length);t.characters.forEach((e=>{if(e.level>1)for(let t=1;t<e.level;t++)this.updateChar(e)})),0!==d.playerTeam.length&&d.playerTeam.forEach((e=>{this.updateChar(e.character),e.character.level++,t.characters.push(e.character)}));const a=n(e,d.gameLevel,d.gameLevel+1-d.compTeam.length);return a.characters.forEach((e=>{if(e.level>1)for(let t=1;t<e.level;t++)this.updateChar(e)})),0!==d.compTeam.length&&d.compTeam.forEach((e=>{this.updateChar(e.character),e.character.level++,t.characters.push(e.character)})),d.playerTeam=[],d.compTeam=[],{playerTeam:t,pcTeam:a}}placeCharacters(e){const t=[],s=[];t.push(...this.getStartPositionsArray(0)),t.push(...this.getStartPositionsArray(1)),s.push(...this.getStartPositionsArray(6)),s.push(...this.getStartPositionsArray(7));const r=[];let i,c,l;for(let s=0;s<e.playerTeam.characters.length;s++){if(0===d.playerTeam.length)c=this.getRandomCell(t);else{let e=!1;do{i=this.getRandomCell(t),e=d.playerTeam.every((e=>e.position!==i))}while(!e);c=i}const l=new a(e.playerTeam.characters[s],c);d.playerTeam.push(l),r.push(l)}for(let t=0;t<e.pcTeam.characters.length;t++){if(0===d.compTeam.length)l=this.getRandomCell(s);else{let e=!1;do{i=this.getRandomCell(s),e=d.compTeam.every((e=>e.position!==i))}while(!e);l=i}const c=new a(e.pcTeam.characters[t],l);d.compTeam.push(c),r.push(c)}return r}getStartPositionsArray(e){const t=[];for(let a=e;a<64;a+=8)t.push(a);return t}getRandomCell(e){return e[Math.floor(Math.random()*e.length)]}getCharInfo(e){const t=d.compTeam.find((t=>t.position===e))||d.playerTeam.find((t=>t.position===e));if(t)return`🎖${t.character.level} ⚔${t.character.attack} 🛡${t.character.defence} ❤${t.character.health}`}findAllowedToTurn(e,t){let a;switch(t){case"swordsman":case"undead":a=4;break;case"bowman":case"vampire":a=2;break;case"magician":case"daemon":a=1}return this.findTurns(e,a)}findAllowedToAttack(e,t){let a;switch(t){case"swordsman":case"undead":a=1;break;case"bowman":case"vampire":a=2;break;case"magician":case"daemon":a=4}return this.findTurns(e,a)}findTurns(e,t){const a=this.getFieldRows().find((t=>t.includes(e))).sort(((e,t)=>e-t)),s=a.findIndex((t=>t===e)),r=this.getFieldCols().find((t=>t.includes(e))).sort(((e,t)=>e-t)),i=r.findIndex((t=>t===e)),c=this.getRightToLeftDiag().find((t=>t.includes(e))).sort(((e,t)=>e-t)),l=c.findIndex((t=>t===e)),o=this.getLeftToRightDiag().find((t=>t.includes(e))).sort(((e,t)=>e-t)),h=o.findIndex((t=>t===e)),n=[],d=[],m=[],p=[],u=[],g=[],y=[],f=[];for(let C=1;C<=t;C++)i-C>=0&&n.push(e-8*C),i+C<r.length&&u.push(e+8*C),s+C<a.length&&m.push(e+C),s-C>=0&&y.push(e-C),l-C>=0&&d.push(c[l-C]),l+C<c.length&&g.push(c[l+C]),h-C>=0&&f.push(o[h-C]),h+C<o.length&&p.push(o[h+C]);return[].concat(n,d,m,p,u,g,y,f)}getFieldRows(){const e=[];let t=[];for(let a=0;a<this.gamePlay.boardSize**2;a++)t.length==this.gamePlay.boardSize?(e.push(t),t=[],t.push(a)):a==this.gamePlay.boardSize**2-1?(t.push(a),e.push(t)):t.push(a);return e}getFieldCols(){let e=[];for(let t=0;t<this.gamePlay.boardSize;t++)e.push([]);let t=0;for(let a=0;a<this.gamePlay.boardSize**2;a++)t<this.gamePlay.boardSize?(e[t].push(a),t++):(t=0,e[t].push(a),t++);return e}getRightToLeftDiag(){const e=this.getFieldRows(),t=[];for(let e=0;e<2*this.gamePlay.boardSize-1;e++)t.push([]);for(let a=0;a<this.gamePlay.boardSize;a++)for(let s=0;s<a+1;s++)t[a].push(e[s][a-s]);for(let a=1;a<this.gamePlay.boardSize;a++)for(let s=this.gamePlay.boardSize-1;s>a-1;s--)t[a+this.gamePlay.boardSize-1].push(e[s][this.gamePlay.boardSize-1+a-s]);return t}getLeftToRightDiag(){const e=this.getFieldRows(),t=[];for(let e=0;e<2*this.gamePlay.boardSize-1;e++)t.push([]);for(let a=0;a<this.gamePlay.boardSize;a++)for(let s=0;s<a+1;s++)t[a].push(e[this.gamePlay.boardSize-1-s][a-s]);for(let a=1;a<this.gamePlay.boardSize;a++)for(let s=0;s<this.gamePlay.boardSize-a;s++)t[a+this.gamePlay.boardSize-1].push(e[s][a+s]);return t}attackRival(e,t,a){const s=Number(Math.max(t.attack-a.defence,.1*t.attack).toFixed(1));this.gamePlay.showDamage(e,s).then((()=>{a.health-s>0?a.health=Number((a.health-s).toFixed(1)):(a.health=0,this.removeDiedChars());let e=!1;"player"===d.turn?(d.playerScore=Number((d.playerScore+s).toFixed(1)),e=!0):d.compScore=Number((d.compScore+s).toFixed(1)),d.turn="comp"===d.turn?"player":"comp",this.updateScores(),this.gamePlay.redrawPositions(this.places),0===d.playerTeam.length||0===d.compTeam.length?this.upStageGame():e&&(e=!1,this.compTurn())}))}removeDiedChars(){const e=d.playerTeam.length,t=d.playerTeam.filter((e=>0!==e.character.health));d.playerTeam=[...t],e!==d.playerTeam.length&&this.showMessage("Ваш персонаж был убит","red");const a=d.compTeam.length,s=d.compTeam.filter((e=>0!==e.character.health));d.compTeam=[...s];const r=this.places.filter((e=>0!==e.character.health));a!==d.compTeam.length&&this.showMessage("Персонаж компьютера был убит","orange"),this.places=[...r]}updateScores(){const e=document.querySelector(".playerScore"),t=document.querySelector(".compScore"),a=document.querySelector(".hiScore");e.textContent=d.playerScore,t.textContent=d.compScore,a.textContent=d.hiScore}playerTurn(e,t,a){d.turn="player";const s=this.findAllowedToTurn(d.selectedChar.position,d.selectedChar.character.type),r=this.findAllowedToAttack(d.selectedChar.position,d.selectedChar.character.type);if(s.includes(e)||r.includes(e)){if(t)this.gamePlay.deselectCell(d.selectedChar.position),this.gamePlay.selectCell(e),d.selectedChar.character=t.character,d.selectedChar.position=t.position;else if(a)r.includes(e)&&(this.attackRival(e,d.selectedChar.character,a.character),this.gamePlay.deselectCell(d.selectedChar.position),this.gamePlay.deselectCell(e),d.selectedChar={},this.showMessage("Вы успешно атаковали","yellow"));else if(s.includes(e)){const t=[];t.push({character:d.selectedChar.character,position:e}),d.compTeam.forEach((a=>{a.position!==d.selectedChar.position?t.push({character:a.character,position:a.position}):a.position=e})),d.playerTeam.forEach((a=>{a.position!==d.selectedChar.position?t.push({character:a.character,position:a.position}):a.position=e})),this.gamePlay.deselectCell(d.selectedChar.position),this.gamePlay.deselectCell(e),this.gamePlay.redrawPositions(t),d.selectedChar={},this.showMessage("Вы успешно сходили","rgba(117, 241, 148, 0.623)"),this.setPlaces(),this.compTurn()}}else t&&(this.gamePlay.deselectCell(d.selectedChar.position),this.gamePlay.selectCell(e),d.selectedChar.character=t.character,d.selectedChar.position=t.position)}compTurn(){d.turn="comp";let e=null,t=null;if(d.compTeam.forEach((a=>{this.findAllowedToAttack(a.position,a.character.type).forEach((s=>{d.playerTeam.forEach((r=>{r.position===s&&(e=a,t=r,d.selectedChar.character=a.character,d.selectedChar.position=a.position)}))}))})),null!==e&&null!==t)this.attackRival(t.position,e.character,t.character),d.selectedChar.character=e.character,d.selectedChar.position=e.position,this.gamePlay.deselectCell(d.selectedChar.position),this.gamePlay.deselectCell(t.position),d.selectedChar={};else{d.playerTeam.sort(((e,t)=>e.character.health===t.character.health?e.character.level-t.character.level:e.character.health-t.character.health));const e=d.playerTeam[0];let t=null;d.compTeam.forEach((a=>{a.position-e.position>0?(null===t||t.position>a.position)&&(t=a):(null===t||t.position<a.position)&&(t=a)})),d.selectedChar.character=t.character,d.selectedChar.position=t.position;const a=this.findAllowedToTurn(d.selectedChar.position,d.selectedChar.character.type);let s,r=!1,i=!1;do{s=Math.floor(Math.random()*a.length),r=d.compTeam.every((e=>e.position!==a[s])),i=d.playerTeam.every((e=>e.position!==a[s]))}while(!1===r||!1===i);const c=[];c.push({character:d.selectedChar.character,position:a[s]}),d.playerTeam.forEach((e=>c.push({character:e.character,position:e.position}))),d.compTeam.forEach((e=>{e.position!==d.selectedChar.position?c.push({character:e.character,position:e.position}):e.position=a[s]})),d.selectedChar.position=t.position,this.gamePlay.deselectCell(d.selectedChar.position),this.gamePlay.deselectCell(e.position),this.gamePlay.redrawPositions(c),d.selectedChar={}}this.setPlaces()}showMessage(e,t="red"){const a=document.querySelector(".messageBox");clearTimeout(this.messageTimeout),a.style.color=t,a.textContent=e,this.messageTimeout=setTimeout((()=>a.textContent=""),2e3)}upStageGame(){if(d.gameLevel<4){d.gameLevel++,this.gamePlay.drawUi(e[this.theamSelect()]);const t=this.createTeams();this.places=this.placeCharacters(t),this.gamePlay.redrawPositions(this.places)}else this.finishTheGame()}theamSelect(){switch(d.gameLevel){case 1:return"prairie";case 2:return"desert";case 3:return"arctic";case 4:return"mountain"}}updateChar(e){e.attack=Number((1.1*e.attack).toFixed(1)),e.defence=Number((1.1*e.defence).toFixed(1)),e.health=Number((e.health+80>100?100:e.health+80).toFixed(1))}finishTheGame(){const e=Math.max(d.playerScore,d.compScore),t=d.playerScore>d.compScore?"Игрок":"Компьютер";if(0===d.hiScore)d.hiScore=e;else if(d.hiScore<e){d.hiScore=e,this.stateService.load();const a=JSON.parse(this.stateService.storage.state);a.hiScore=d.hiScore,this.stateService.save(a),this.showMessage(`Игра окончена. Победил ${t}. Установлен новый рекорд ${e} оч.`,"pink")}else this.showMessage(`Игра окончена. Победил ${t}.`,"pink");document.querySelector(".boardCover").style.display="block"}startNewGame(){d.gameLevel=1,d.playerTeam=[],d.compTeam=[],d.selectedChar={},d.turn="player",d.playerScore=0,d.compScore=0,d.hiScore=0,this.gamePlay.drawUi(e[this.theamSelect()]);const t=this.createTeams();this.places=this.placeCharacters(t),this.gamePlay.redrawPositions(this.places),this.restoreHiScore(),this.updateScores()}loadGame(){this.stateService.load();const t=JSON.parse(this.stateService.storage.state);for(let e in t)"compTeam"===e?(d.compTeam=[],t[e].forEach((t=>{const a=this.reCreateCharacter(t.character.type,t.character.level);a.health=t.character.health,a.attack=t.character.attack,a.defence=t.character.defence,d[e].push({character:a,position:t.position})}))):"playerTeam"===e?(d.playerTeam=[],t.playerTeam.forEach((t=>{const a=this.reCreateCharacter(t.character.type,t.character.level);a.health=t.character.health,a.attack=t.character.attack,a.defence=t.character.defence,d[e].push({character:a,position:t.position})}))):d[e]=t[e];this.gamePlay.drawUi(e[this.theamSelect()]),this.setPlaces(),this.gamePlay.redrawPositions(this.places),this.updateScores()}reCreateCharacter(e,t){return new{swordsman:i,undead:l,bowman:s,vampire:o,magician:c,daemon:r}[e](t)}saveGame(){this.stateService.save(d),this.updateScores()}setPlaces(){this.places=[],d.compTeam.forEach((e=>this.places.push({character:e.character,position:e.position}))),d.playerTeam.forEach((e=>this.places.push({character:e.character,position:e.position})))}restoreHiScore(){if(this.stateService.load(),this.stateService.storage.state){const e=JSON.parse(this.stateService.storage.state);d.hiScore=e.hiScore}}}(m,p);u.init()})();